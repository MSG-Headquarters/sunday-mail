<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sunday | Your Digital Mailbox</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üì¨</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD4QQIX_CakJd_mNUMWzzM8tknQ2abv6ZI&libraries=places&callback=initGooglePlaces" async defer></script>
    <style>
        :root{--bg-white:#FFF;--bg-light:#F0F9FF;--bg-gray:#F1F5F9;--primary:#0EA5E9;--primary-dark:#0284C7;--primary-light:#E0F2FE;--accent-teal:#14B8A6;--accent-emerald:#10B981;--accent-amber:#F59E0B;--accent-rose:#F43F5E;--accent-violet:#8B5CF6;--accent-gold:#D4AF37;--text-primary:#1E293B;--text-secondary:#475569;--text-muted:#64748B;--border:#E2E8F0;--gradient-start:#0EA5E9;--gradient-end:#14B8A6}
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg-light);color:var(--text-primary);min-height:100vh}
        .auth-container{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;background:linear-gradient(135deg,var(--bg-light) 0%,#D1FAE5 100%)}
        .auth-card{background:var(--bg-white);border-radius:24px;box-shadow:0 8px 32px rgba(0,0,0,0.08);padding:40px;width:100%;max-width:420px}
        .auth-logo{display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:32px}
        .auth-logo-icon{width:56px;height:56px;background:linear-gradient(135deg,var(--gradient-start),var(--gradient-end));border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:28px;box-shadow:0 4px 12px rgba(14,165,233,0.3)}
        .auth-logo-text{font-size:32px;font-weight:800;background:linear-gradient(135deg,var(--gradient-start),var(--gradient-end));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        .auth-title{font-size:24px;font-weight:700;text-align:center;margin-bottom:8px}
        .auth-subtitle{font-size:15px;color:var(--text-muted);text-align:center;margin-bottom:28px}
        .version-badge{font-size:10px;color:var(--text-muted);background:var(--bg-gray);padding:2px 8px;border-radius:100px;margin-left:8px}
        .input-group{margin-bottom:20px}.input-label{display:block;font-size:13px;font-weight:600;color:var(--text-secondary);margin-bottom:8px}
        .input-field{width:100%;padding:14px 16px;border:2px solid var(--border);border-radius:12px;font-size:16px;font-family:inherit;transition:all 0.2s;background:var(--bg-gray)}
        .input-field:focus{outline:none;border-color:var(--primary);background:var(--bg-white);box-shadow:0 0 0 4px rgba(14,165,233,0.1)}
        .input-row{display:flex;gap:12px}.input-row .input-group{flex:1}
        .btn{width:100%;padding:16px;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px;transition:all 0.2s}
        .btn-primary{background:linear-gradient(135deg,var(--gradient-start),var(--gradient-end));color:white;box-shadow:0 4px 12px rgba(14,165,233,0.3)}
        .btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(14,165,233,0.4)}
        .btn-primary:disabled{opacity:0.5;cursor:not-allowed;transform:none}
        .btn-success{background:var(--accent-emerald);color:white}
        .btn-danger{background:var(--accent-rose);color:white}
        .btn-outline{background:transparent;color:var(--primary);border:2px solid var(--primary);margin-top:12px}
        .btn-outline:hover{background:var(--primary-light)}
        .btn-ghost{background:var(--bg-gray);color:var(--text-secondary);border:1px solid var(--border)}
        .btn-ghost:hover{background:var(--border)}
        .btn-sm{padding:10px 16px;font-size:14px;width:auto}
        .btn-loading{pointer-events:none;opacity:0.7}
        .spinner{width:20px;height:20px;border:2px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;animation:spin 0.8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .toast-container{position:fixed;top:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:10px}
        .toast{padding:16px 20px;border-radius:12px;background:var(--bg-white);box-shadow:0 8px 32px rgba(0,0,0,0.15);display:flex;align-items:center;gap:12px;animation:slideIn 0.3s ease;max-width:380px}
        .toast.success{border-left:4px solid var(--accent-emerald)}.toast.error{border-left:4px solid var(--accent-rose)}.toast.info{border-left:4px solid var(--primary)}.toast.warning{border-left:4px solid var(--accent-amber)}
        .toast-icon{font-size:20px}.toast-content{flex:1}.toast-title{font-weight:600;font-size:14px;margin-bottom:2px}.toast-message{font-size:13px;color:var(--text-muted)}.toast-close{background:none;border:none;font-size:18px;cursor:pointer;color:var(--text-muted);padding:4px}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        .error-box{background:rgba(239,68,68,0.1);border-left:4px solid var(--accent-rose);padding:14px;margin-top:16px;color:var(--accent-rose);font-size:14px;border-radius:0 12px 12px 0}
        .success-box{background:rgba(16,185,129,0.1);border-left:4px solid var(--accent-emerald);padding:14px;margin-top:16px;color:var(--accent-emerald);font-size:14px;border-radius:0 12px 12px 0}
        .warning-box{background:rgba(245,158,11,0.1);border-left:4px solid var(--accent-amber);padding:14px;margin-top:16px;color:#92400E;font-size:14px;border-radius:0 12px 12px 0}
        .hidden{display:none!important}
        .tier-badge{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:100px;font-size:11px;font-weight:600}
        .tier-badge.owner{background:linear-gradient(135deg,#FEF3C7,#FDE68A);color:#92400E}
        .tier-badge.primary{background:linear-gradient(135deg,#DBEAFE,#BFDBFE);color:#1E40AF}
        .tier-badge.secondary{background:linear-gradient(135deg,#E0E7FF,#C7D2FE);color:#3730A3}
        .tier-badge.dependent{background:linear-gradient(135deg,#F3E8FF,#E9D5FF);color:#6B21A8}
        .tier-badge.pending{background:linear-gradient(135deg,#FEE2E2,#FECACA);color:#991B1B}
        .tier-badge.claimed{background:linear-gradient(135deg,#D1FAE5,#A7F3D0);color:#065F46}
        .notification-badge{position:absolute;top:-4px;right:-4px;background:var(--accent-rose);color:white;font-size:10px;font-weight:700;min-width:18px;height:18px;border-radius:9px;display:flex;align-items:center;justify-content:center}
        .dashboard{min-height:100vh;background:var(--bg-light)}
        .topnav{background:var(--bg-white);border-bottom:1px solid var(--border);padding:0 32px;height:64px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
        .topnav-logo{display:flex;align-items:center;gap:10px}
        .topnav-logo-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--gradient-start),var(--gradient-end));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px}
        .topnav-logo-text{font-size:20px;font-weight:800;color:var(--text-primary)}
        .topnav-actions{display:flex;align-items:center;gap:16px}
        .topnav-link{color:var(--text-secondary);text-decoration:none;font-size:14px;font-weight:500;display:flex;align-items:center;gap:6px;position:relative;cursor:pointer;padding:8px 12px;border-radius:8px;transition:all 0.2s}
        .topnav-link:hover{color:var(--primary);background:var(--primary-light)}
        .welcome-header{background:linear-gradient(135deg,var(--gradient-start),var(--gradient-end));padding:32px;margin:24px 32px;border-radius:20px;color:white}
        .welcome-title{font-size:28px;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:12px}
        .welcome-subtitle{font-size:15px;opacity:0.9}
        .tab-nav{display:flex;gap:8px;padding:0 32px;margin-bottom:24px;flex-wrap:wrap}
        .tab-btn{padding:12px 20px;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;border:none;background:transparent;color:var(--text-muted);display:flex;align-items:center;gap:8px;transition:all 0.2s;position:relative}
        .tab-btn:hover{background:var(--bg-white);color:var(--text-primary)}
        .tab-btn.active{background:var(--primary);color:white;box-shadow:0 4px 12px rgba(14,165,233,0.3)}
        .tab-btn.owner-tab{background:linear-gradient(135deg,#D4AF37,#B8860B);color:white}
        .tab-btn.owner-tab:hover{background:linear-gradient(135deg,#E5C158,#C9972C)}
        .tab-btn.owner-tab.active{background:linear-gradient(135deg,#D4AF37,#B8860B);box-shadow:0 4px 12px rgba(212,175,55,0.4)}
        .main-content{padding:0 32px 32px}.content-grid{display:grid;grid-template-columns:1fr 340px;gap:24px}
        .card{background:var(--bg-white);border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,0.04);overflow:hidden}
        .card-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
        .card-title{font-size:16px;font-weight:700;color:var(--text-primary)}.card-body{padding:24px}
        .quick-stats{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        .stat-item{padding:16px;border-radius:12px;text-align:center}
        .stat-item.blue{background:#DBEAFE}.stat-item.yellow{background:#FEF3C7}.stat-item.green{background:#D1FAE5}.stat-item.purple{background:#EDE9FE}.stat-item.gold{background:linear-gradient(135deg,#FEF3C7,#FDE68A)}
        .stat-value{font-size:28px;font-weight:700}
        .stat-item.blue .stat-value{color:var(--primary)}.stat-item.yellow .stat-value{color:var(--accent-amber)}.stat-item.green .stat-value{color:var(--accent-emerald)}.stat-item.purple .stat-value{color:var(--accent-violet)}.stat-item.gold .stat-value{color:var(--accent-gold)}
        .stat-label{font-size:12px;color:var(--text-muted);margin-top:4px}
        .quick-actions{display:flex;flex-direction:column;gap:10px}
        .action-btn{display:flex;align-items:center;gap:12px;padding:14px 16px;border-radius:12px;border:none;background:var(--bg-gray);cursor:pointer;transition:all 0.2s;text-align:left;width:100%}
        .action-btn:hover{background:var(--border);transform:translateX(4px)}
        .action-btn.primary{background:linear-gradient(135deg,rgba(14,165,233,0.1),rgba(20,184,166,0.1))}
        .action-btn.primary:hover{background:linear-gradient(135deg,rgba(14,165,233,0.2),rgba(20,184,166,0.2))}
        .action-icon{font-size:20px}.action-text{font-size:14px;font-weight:600;color:var(--text-primary)}
        .address-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}.address-title{font-size:18px;font-weight:700}
        .address-empty{text-align:center;padding:48px 24px}.address-empty-icon{font-size:64px;margin-bottom:16px}.address-empty-title{font-size:18px;font-weight:600;color:var(--text-primary);margin-bottom:8px}.address-empty-text{font-size:14px;color:var(--text-muted);margin-bottom:16px}.address-empty-link{color:var(--primary);font-weight:600;cursor:pointer}.address-empty-link:hover{text-decoration:underline}
        .address-card{background:var(--bg-gray);border-radius:12px;padding:20px;margin-bottom:12px;transition:all 0.2s}.address-card:hover{box-shadow:0 4px 12px rgba(0,0,0,0.05)}
        .address-card-header{display:flex;align-items:start;justify-content:space-between;margin-bottom:12px}.address-card-icon{font-size:28px}
        .address-card-street{font-size:16px;font-weight:600;margin-bottom:4px}.address-card-city{font-size:14px;color:var(--text-muted);margin-bottom:12px}
        .address-card-cpid{font-family:'SF Mono',Monaco,monospace;font-size:12px;color:var(--primary);background:var(--primary-light);padding:10px 14px;border-radius:8px;display:flex;align-items:center;justify-content:space-between}
        .copy-btn{background:none;border:none;cursor:pointer;font-size:14px;transition:transform 0.2s}.copy-btn:hover{transform:scale(1.1)}.copy-btn.copied{color:var(--accent-emerald)}
        .request-card{background:var(--bg-gray);border-radius:12px;padding:20px;margin-bottom:12px;border-left:4px solid var(--accent-amber)}
        .request-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
        .request-user{display:flex;align-items:center;gap:12px}
        .request-avatar{width:40px;height:40px;background:linear-gradient(135deg,var(--primary),var(--accent-teal));border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:600}
        .request-info h4{font-size:15px;font-weight:600;margin-bottom:2px}.request-info p{font-size:13px;color:var(--text-muted)}
        .request-address{font-size:13px;color:var(--text-secondary);margin-bottom:12px;padding:10px;background:var(--bg-white);border-radius:8px}
        .request-tier{display:flex;align-items:center;gap:8px;margin-bottom:16px}.request-tier-label{font-size:12px;color:var(--text-muted)}
        .request-actions{display:flex;gap:8px}.request-actions .btn{flex:1}
        .resident-item{display:flex;align-items:center;justify-content:space-between;padding:14px;background:var(--bg-white);border-radius:10px;margin-bottom:8px}
        .resident-info{display:flex;align-items:center;gap:12px}
        .resident-avatar{width:36px;height:36px;background:var(--bg-gray);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px}
        .resident-name{font-size:14px;font-weight:600}.resident-phone{font-size:12px;color:var(--text-muted)}
        .message-item{display:flex;align-items:start;gap:16px;padding:16px 0;border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.15s;margin:0 -24px;padding-left:24px;padding-right:24px}
        .message-item:hover{background:var(--bg-light)}.message-item:last-child{border-bottom:none}
        .message-item.unread{background:rgba(14,165,233,0.05)}.message-item.unread .message-subject{font-weight:700}
        .message-dot{width:10px;height:10px;background:var(--primary);border-radius:50%;margin-top:6px;flex-shrink:0}.message-dot.read{background:transparent}
        .message-content{flex:1;min-width:0}.message-from{font-size:13px;color:var(--text-muted);margin-bottom:4px}
        .message-subject{font-size:15px;font-weight:500;color:var(--text-primary);margin-bottom:4px}
        .message-preview{font-size:13px;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .message-meta{text-align:right;flex-shrink:0}.message-date{font-size:12px;color:var(--text-muted)}
        .message-address-tag{font-size:11px;color:var(--primary);background:var(--primary-light);padding:4px 8px;border-radius:6px;margin-top:6px;display:inline-block}
        .message-view{padding:32px}.message-view-header{margin-bottom:24px;padding-bottom:24px;border-bottom:1px solid var(--border)}
        .message-view-subject{font-size:24px;font-weight:700;margin-bottom:16px}.message-view-meta{display:flex;flex-wrap:wrap;gap:20px;font-size:14px;color:var(--text-secondary)}
        .message-view-body{font-size:16px;line-height:1.8;color:var(--text-primary);white-space:pre-wrap}
        .compose-form textarea{width:100%;min-height:200px;padding:16px;border:2px solid var(--border);border-radius:12px;font-size:15px;font-family:inherit;resize:vertical;background:var(--bg-gray)}
        .compose-form textarea:focus{outline:none;border-color:var(--primary);background:var(--bg-white)}
        .claim-preview{background:linear-gradient(135deg,rgba(14,165,233,0.1),rgba(20,184,166,0.1));padding:20px;border-radius:12px;margin-bottom:20px}
        .claim-preview-label{font-size:12px;font-weight:600;color:var(--primary);margin-bottom:8px;display:flex;align-items:center;gap:6px}.claim-preview-text{font-size:15px;color:var(--text-primary)}
        .owner-info-box{background:linear-gradient(135deg,#FEF3C7,#FDE68A);padding:20px;border-radius:12px;margin-bottom:20px}
        .owner-info-box h4{font-size:14px;font-weight:700;color:#92400E;margin-bottom:8px;display:flex;align-items:center;gap:8px}.owner-info-box p{font-size:13px;color:#78350F;line-height:1.5}
        .tier-select{display:flex;flex-direction:column;gap:10px;margin:16px 0}
        .tier-option{display:flex;align-items:center;gap:12px;padding:16px;background:var(--bg-gray);border-radius:12px;cursor:pointer;border:2px solid transparent;transition:all 0.2s}
        .tier-option:hover{border-color:var(--primary)}.tier-option.selected{border-color:var(--primary);background:var(--primary-light)}.tier-option.disabled{opacity:0.5;pointer-events:none}
        .tier-option input{display:none}.tier-icon{font-size:24px}.tier-details h4{font-size:14px;font-weight:600;margin-bottom:2px}.tier-details p{font-size:12px;color:var(--text-muted)}
        .camera-container{position:relative;width:100%;aspect-ratio:4/3;background:#000;border-radius:16px;overflow:hidden;margin-bottom:20px}
        .camera-video{width:100%;height:100%;object-fit:cover}
        .camera-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
        .camera-frame{border:3px dashed rgba(255,255,255,0.6);border-radius:12px;width:85%;height:60%}.camera-frame.selfie{width:60%;height:75%;border-radius:50%}
        .capture-preview{width:100%;border-radius:16px;margin-bottom:20px}
        .progress-bar{width:100%;height:10px;background:var(--border);border-radius:5px;overflow:hidden;margin:20px 0}
        .progress-fill{height:100%;background:linear-gradient(90deg,var(--gradient-start),var(--gradient-end));transition:width 0.3s}
        .pac-container{border-radius:12px;border:none;box-shadow:0 8px 32px rgba(0,0,0,0.15);margin-top:8px;font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;z-index:10000}
        .pac-item{padding:12px 16px;cursor:pointer;font-size:14px;border-top:1px solid var(--border)}
        .pac-item:first-child{border-top:none;border-radius:12px 12px 0 0}
        .pac-item:last-child{border-radius:0 0 12px 12px}
        .pac-item:hover,.pac-item-selected{background:var(--primary-light)}
        .pac-icon{display:none}
        .pac-item-query{font-weight:600;color:var(--text-primary)}
        .pac-matched{font-weight:700;color:var(--primary)}
        @media(max-width:1024px){.content-grid{grid-template-columns:1fr}.topnav{padding:0 16px}.welcome-header{margin:16px}.tab-nav{padding:0 16px;overflow-x:auto;flex-wrap:nowrap}.main-content{padding:0 16px 16px}}
        @media(max-width:640px){.welcome-title{font-size:22px}.tab-btn{padding:10px 14px;font-size:13px;white-space:nowrap}.auth-card{padding:24px}}
    </style>
</head>

<body>
    <div class="toast-container" id="toast-container"></div>
    
    <!-- AUTH: Registration -->
    <div class="auth-container" id="screen-register">
        <div class="auth-card">
            <div class="auth-logo"><div class="auth-logo-icon">üì¨</div><span class="auth-logo-text">SUNDAY</span><span class="version-badge">v7.5</span></div>
            <h2 class="auth-title">Create Your Account</h2>
            <p class="auth-subtitle">Secure, passwordless digital mailbox</p>
            <div class="input-group"><label class="input-label">Display Name</label><input type="text" class="input-field" id="reg-name" placeholder="Your name"></div>
            <div class="input-group"><label class="input-label">Phone Number</label><input type="tel" class="input-field" id="reg-phone" placeholder="+1 (555) 123-4567"></div>
            <button class="btn btn-primary" id="btn-register" onclick="startRegistration()"><span>üîê</span> Register with Face ID</button>
            <button class="btn btn-outline" onclick="showScreen('login')">Already have an account? Sign in</button>
            <div id="reg-error" class="error-box hidden"></div>
        </div>
    </div>

    <!-- AUTH: Login -->
    <div class="auth-container hidden" id="screen-login">
        <div class="auth-card">
            <div class="auth-logo"><div class="auth-logo-icon">üì¨</div><span class="auth-logo-text">SUNDAY</span><span class="version-badge">v7.5</span></div>
            <h2 class="auth-title">Welcome Back</h2>
            <p class="auth-subtitle">Sign in with your biometric</p>
            <button class="btn btn-primary" id="btn-login" onclick="startLogin()"><span>üëÜ</span> Sign in with Face ID</button>
            <button class="btn btn-outline" onclick="showScreen('register')">Need an account? Register</button>
            <div id="login-error" class="error-box hidden"></div>
        </div>
    </div>

    <!-- AUTH: Identity Verification -->
    <div class="auth-container hidden" id="screen-verify">
        <div class="auth-card">
            <div class="auth-logo"><div class="auth-logo-icon">üì¨</div><span class="auth-logo-text">SUNDAY</span></div>
            <h2 class="auth-title">Verify Your Identity</h2>
            <p class="auth-subtitle" id="verify-subtitle">Scan your driver's license</p>
            <div id="verify-dl-section">
                <div class="camera-container"><video id="dl-video" class="camera-video" autoplay playsinline></video><div class="camera-overlay"><div class="camera-frame"></div></div></div>
                <img id="dl-preview" class="capture-preview hidden">
                <button class="btn btn-primary" id="btn-capture-dl" onclick="captureDL()">üì∏ Capture DL</button>
                <button class="btn btn-ghost hidden" id="btn-retake-dl" onclick="retakeDL()">Retake</button>
                <button class="btn btn-success hidden" id="btn-confirm-dl" onclick="confirmDL()">‚úì Continue to Selfie</button>
            </div>
            <div id="verify-selfie-section" class="hidden">
                <div class="camera-container"><video id="selfie-video" class="camera-video" autoplay playsinline></video><div class="camera-overlay"><div class="camera-frame selfie"></div></div></div>
                <img id="selfie-preview" class="capture-preview hidden">
                <button class="btn btn-primary" id="btn-capture-selfie" onclick="captureSelfie()">ü§≥ Take Selfie</button>
                <button class="btn btn-ghost hidden" id="btn-retake-selfie" onclick="retakeSelfie()">Retake</button>
                <button class="btn btn-success hidden" id="btn-confirm-selfie" onclick="confirmSelfie()">‚úì Verify Identity</button>
            </div>
            <div id="verify-processing-section" class="hidden" style="text-align:center;padding:40px 0;">
                <div style="font-size:56px;margin-bottom:20px;">üîç</div>
                <div class="progress-bar"><div class="progress-fill" id="verify-progress" style="width:0%"></div></div>
                <p id="verify-status" style="color:var(--text-muted);font-size:15px;">Processing...</p>
            </div>
            <button class="btn btn-outline" onclick="skipVerification()" style="margin-top:16px;">Skip for now</button>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div class="dashboard hidden" id="screen-dashboard">
        <nav class="topnav">
            <div class="topnav-logo"><div class="topnav-logo-icon">üì¨</div><span class="topnav-logo-text">SUNDAY</span><span class="version-badge">v7.5</span></div>
            <div class="topnav-actions">
                <a class="topnav-link" onclick="setTab('inbox')"><span>‚úâÔ∏è</span> Inbox</a>
                <a class="topnav-link" onclick="setTab('owner-dashboard')" style="position:relative;"><span>üëë</span> Owner<span class="notification-badge hidden" id="owner-notification-badge">0</span></a>
                <a class="topnav-link" onclick="setTab('compose')"><span>üì§</span> Send</a>
                <a class="topnav-link" onclick="signOut()"><span>üö™</span></a>
            </div>
        </nav>
        <div class="welcome-header">
            <h1 class="welcome-title">Welcome back, <span id="user-name">User</span>! <span>üëã</span></h1>
            <p class="welcome-subtitle" id="welcome-message">Your inbox is empty.</p>
        </div>
        <div class="tab-nav">
            <button class="tab-btn active" onclick="setTab('inbox')" data-tab="inbox">üì• Inbox</button>
            <button class="tab-btn" onclick="setTab('sent')" data-tab="sent">üì§ Sent</button>
            <button class="tab-btn" onclick="setTab('addresses')" data-tab="addresses">üè† My Addresses</button>
            <button class="tab-btn owner-tab" onclick="setTab('owner-dashboard')" data-tab="owner-dashboard" style="position:relative;">üëë Owner Dashboard<span class="notification-badge hidden" id="tab-owner-badge">0</span></button>
            <button class="tab-btn" onclick="setTab('locker')" data-tab="locker">üîí The Locker</button>
            <button class="tab-btn" onclick="setTab('settings')" data-tab="settings">‚öôÔ∏è Settings</button>
        </div>
        <div class="main-content">
            <div class="content-grid">
                <div>
                    <div id="tab-inbox" class="card"><div class="card-body" id="inbox-content"></div></div>
                    <div id="tab-sent" class="card hidden"><div class="card-body" id="sent-content"></div></div>
                    <div id="tab-addresses" class="card hidden"><div class="card-body" id="addresses-content"></div></div>
                    <div id="tab-owner-dashboard" class="card hidden"><div class="card-header" style="background:linear-gradient(135deg,rgba(212,175,55,0.15),rgba(184,134,11,0.1));"><span class="card-title">üëë Owner Dashboard</span><span class="tier-badge owner">Property Owner</span></div><div class="card-body" id="owner-dashboard-content"></div></div>
                    <div id="tab-locker" class="card hidden"><div class="card-header"><span class="card-title">üîí The Locker - Connected Apps</span></div><div class="card-body" id="locker-content"></div></div>
                    <div id="tab-settings" class="card hidden"><div class="card-body" id="settings-content"></div></div>
                    <div id="tab-compose" class="card hidden"><div class="card-header"><span class="card-title">‚úâÔ∏è Compose Message</span></div><div class="card-body" id="compose-content"></div></div>
                    <div id="tab-claim" class="card hidden"><div class="card-header"><span class="card-title">üè† Claim New Address</span></div><div class="card-body" id="claim-content"></div></div>
                    <div id="tab-message-view" class="card hidden"><div id="message-view-content"></div></div>
                </div>
                <div>
                    <div class="card" style="margin-bottom:20px;">
                        <div class="card-header"><span class="card-title">üìä Quick Stats</span></div>
                        <div class="card-body">
                            <div class="quick-stats">
                                <div class="stat-item blue"><div class="stat-value" id="stat-received">0</div><div class="stat-label">Received</div></div>
                                <div class="stat-item yellow"><div class="stat-value" id="stat-sent">0</div><div class="stat-label">Sent</div></div>
                                <div class="stat-item purple"><div class="stat-value" id="stat-pending">0</div><div class="stat-label">Pending</div></div>
                                <div class="stat-item gold"><div class="stat-value" id="stat-properties">0</div><div class="stat-label">Properties</div></div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><span class="card-title">‚ö° Quick Actions</span></div>
                        <div class="card-body">
                            <div class="quick-actions">
                                <button class="action-btn primary" onclick="setTab('compose')"><span class="action-icon">‚úâÔ∏è</span><span class="action-text">Send a Message</span></button>
                                <button class="action-btn primary" onclick="setTab('claim')"><span class="action-icon">üè†</span><span class="action-text">Claim New Address</span></button>
                                <button class="action-btn" onclick="setTab('owner-dashboard')"><span class="action-icon">üëë</span><span class="action-text">Manage Properties</span></button>
                                <button class="action-btn" onclick="shareCPiD()"><span class="action-icon">üîó</span><span class="action-text">Share My CPiD</span></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
// ============================================================================
// CONFIGURATION
// ============================================================================
const API_BASE = 'https://sunday-platform.onrender.com';
const RP_ID = 'msg-headquarters.github.io';
const APP_VERSION = '7.5';

// ============================================================================
// STATE
// ============================================================================
let currentToken = null;
let currentUser = null;
let verifiedDLInfo = null;
let messages = [];
let sentMessages = [];
let claims = [];
let ownedProperties = [];
let pendingRequests = [];
let myAccessRequests = [];
let connectedApps = [];
let currentTab = 'inbox';

let dlStream = null, selfieStream = null;
let dlImageData = null, selfieImageData = null;
let faceApiLoaded = false;
let googlePlacesLoaded = false;

let pendingClaimAddress = null;
let pendingClaimAddressId = null;
let addressOwnershipInfo = null;
let selectedClaimTier = null;

const TIERS = {
    OWNER: { name: 'Property Owner', icon: 'üëë', class: 'owner' },
    PRIMARY: { name: 'Primary Resident', icon: 'üè†', class: 'primary' },
    SECONDARY: { name: 'Secondary Resident', icon: 'üîë', class: 'secondary' },
    DEPENDENT: { name: 'Dependent', icon: 'üë§', class: 'dependent' },
    PENDING: { name: 'Pending Approval', icon: '‚è≥', class: 'pending' },
    CLAIMED: { name: 'Claimed', icon: '‚úì', class: 'claimed' }
};

// ============================================================================
// GOOGLE PLACES
// ============================================================================
function initGooglePlaces() {
    googlePlacesLoaded = true;
    console.log('Google Places API loaded');
}

function initAddressAutocomplete(inputId, callback) {
    if (!googlePlacesLoaded || !google?.maps?.places) return null;
    const input = document.getElementById(inputId);
    if (!input) return null;
    
    const autocomplete = new google.maps.places.Autocomplete(input, {
        types: ['address'],
        componentRestrictions: { country: 'us' },
        fields: ['address_components', 'formatted_address']
    });
    
    autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        if (place.address_components) {
            const parsed = parseGoogleAddress(place.address_components);
            if (callback) callback(parsed);
        }
    });
    return autocomplete;
}

function parseGoogleAddress(components) {
    const result = { street: '', city: '', state: '', postalCode: '' };
    let streetNumber = '', streetName = '';
    components.forEach(c => {
        if (c.types.includes('street_number')) streetNumber = c.long_name;
        if (c.types.includes('route')) streetName = c.long_name;
        if (c.types.includes('locality')) result.city = c.long_name;
        if (c.types.includes('sublocality_level_1') && !result.city) result.city = c.long_name;
        if (c.types.includes('administrative_area_level_1')) result.state = c.short_name;
        if (c.types.includes('postal_code')) result.postalCode = c.long_name;
    });
    result.street = streetNumber ? (streetNumber + ' ' + streetName) : streetName;
    return result;
}

// ============================================================================
// UTILITIES
// ============================================================================
function showToast(type, title, message, duration = 4000) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    const icons = { success: '‚úì', error: '‚úó', info: '‚Ñπ', warning: '‚ö†' };
    toast.innerHTML = `<span class="toast-icon">${icons[type] || '‚Ñπ'}</span><div class="toast-content"><div class="toast-title">${title}</div>${message ? `<div class="toast-message">${message}</div>` : ''}</div><button class="toast-close" onclick="this.parentElement.remove()">√ó</button>`;
    container.appendChild(toast);
    setTimeout(() => { toast.style.animation = 'slideOut 0.3s ease forwards'; setTimeout(() => toast.remove(), 300); }, duration);
}

function getTierBadge(tier) {
    const t = TIERS[tier] || TIERS.CLAIMED;
    return `<span class="tier-badge ${t.class}">${t.icon} ${t.name}</span>`;
}

function showScreen(s) {
    document.querySelectorAll('[id^="screen-"]').forEach(el => el.classList.add('hidden'));
    document.getElementById(`screen-${s}`)?.classList.remove('hidden');
}

function showError(id, msg) {
    const el = document.getElementById(id);
    if (el) { el.textContent = msg; el.classList.remove('hidden'); }
}

function hideError(id) {
    const el = document.getElementById(id);
    if (el) el.classList.add('hidden');
}

function setButtonLoading(btnId, loading) {
    const btn = document.getElementById(btnId);
    if (!btn) return;
    if (loading) {
        btn.dataset.originalText = btn.innerHTML;
        btn.innerHTML = '<div class="spinner"></div> Loading...';
        btn.classList.add('btn-loading');
        btn.disabled = true;
    } else {
        btn.innerHTML = btn.dataset.originalText || '';
        btn.classList.remove('btn-loading');
        btn.disabled = false;
    }
}

function base64URLToBuffer(b64) {
    const base64 = b64.replace(/-/g, '+').replace(/_/g, '/');
    const pad = base64.length % 4;
    const padded = pad ? base64 + '='.repeat(4 - pad) : base64;
    const binary = atob(padded);
    const bytes = new Uint8Array(binary.length);
    for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
    return bytes.buffer;
}

function bufferToBase64URL(buffer) {
    const bytes = new Uint8Array(buffer);
    let binary = '';
    for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);
    return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
}

function formatDate(d) {
    if (!d) return 'Unknown';
    const date = new Date(d);
    const now = new Date();
    const diff = now - date;
    if (diff < 86400000) return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    if (diff < 604800000) return date.toLocaleDateString([], { weekday: 'short' });
    return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
}

async function copyToClipboard(text, btnEl) {
    try {
        await navigator.clipboard.writeText(text);
        if (btnEl) {
            const orig = btnEl.textContent;
            btnEl.textContent = '‚úì';
            btnEl.classList.add('copied');
            setTimeout(() => { btnEl.textContent = orig; btnEl.classList.remove('copied'); }, 1500);
        }
        showToast('success', 'Copied!', '');
    } catch { showToast('error', 'Copy failed', ''); }
}

// ============================================================================
// WEBAUTHN AUTHENTICATION
// ============================================================================
async function startRegistration() {
    const name = document.getElementById('reg-name').value.trim() || 'User';
    const phone = document.getElementById('reg-phone').value.trim();
    if (!phone) { showError('reg-error', 'Please enter phone number'); return; }
    hideError('reg-error');
    setButtonLoading('btn-register', true);
    
    try {
        const optRes = await fetch(`${API_BASE}/api/auth/webauthn/register-options`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone, displayName: name })
        });
        if (!optRes.ok) throw new Error((await optRes.json()).error);
        const { options, userId } = await optRes.json();
        
        const cred = await navigator.credentials.create({
            publicKey: {
                challenge: base64URLToBuffer(options.challenge),
                rp: { id: RP_ID, name: options.rp.name },
                user: { id: base64URLToBuffer(options.user.id), name: options.user.name, displayName: options.user.displayName },
                pubKeyCredParams: options.pubKeyCredParams,
                timeout: 60000,
                attestation: 'none',
                authenticatorSelection: { authenticatorAttachment: 'platform', userVerification: 'required', residentKey: 'required', requireResidentKey: true }
            }
        });
        
        const verRes = await fetch(`${API_BASE}/api/auth/webauthn/register-verify`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId,
                credential: {
                    id: cred.id,
                    rawId: bufferToBase64URL(cred.rawId),
                    type: cred.type,
                    response: {
                        clientDataJSON: bufferToBase64URL(cred.response.clientDataJSON),
                        attestationObject: bufferToBase64URL(cred.response.attestationObject),
                        transports: cred.response.getTransports?.() || ['internal']
                    }
                }
            })
        });
        if (!verRes.ok) throw new Error((await verRes.json()).error);
        const { token } = await verRes.json();
        
        currentToken = token;
        currentUser = { name, phone };
        localStorage.setItem('sunday_token', token);
        localStorage.setItem('sunday_user', JSON.stringify(currentUser));
        showToast('success', 'Account created!', 'Welcome to SUNDAY');
        
        const status = await checkIdentityStatus();
        if (!status.identity) { showScreen('verify'); startDLCamera(); }
        else { loadDashboard(); }
    } catch (e) {
        showError('reg-error', e.message);
        showToast('error', 'Registration failed', e.message);
    } finally {
        setButtonLoading('btn-register', false);
    }
}

async function startLogin() {
    hideError('login-error');
    setButtonLoading('btn-login', true);
    
    try {
        const optRes = await fetch(`${API_BASE}/api/auth/webauthn/login-options`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: '{}'
        });
        if (!optRes.ok) throw new Error((await optRes.json()).error);
        const { options, challengeKey } = await optRes.json();
        
        const cred = await navigator.credentials.get({
            publicKey: {
                challenge: base64URLToBuffer(options.challenge),
                rpId: RP_ID,
                timeout: 60000,
                userVerification: 'required'
            }
        });
        
        const verRes = await fetch(`${API_BASE}/api/auth/webauthn/login-verify`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                challengeKey,
                credential: {
                    id: cred.id,
                    rawId: bufferToBase64URL(cred.rawId),
                    type: cred.type,
                    response: {
                        clientDataJSON: bufferToBase64URL(cred.response.clientDataJSON),
                        authenticatorData: bufferToBase64URL(cred.response.authenticatorData),
                        signature: bufferToBase64URL(cred.response.signature),
                        userHandle: cred.response.userHandle ? bufferToBase64URL(cred.response.userHandle) : null
                    }
                }
            })
        });
        if (!verRes.ok) throw new Error((await verRes.json()).error);
        const { token, user } = await verRes.json();
        
        currentToken = token;
        currentUser = user;
        localStorage.setItem('sunday_token', token);
        localStorage.setItem('sunday_user', JSON.stringify(user));
        showToast('success', 'Welcome back!', `Signed in as ${user.name || user.phone}`);
        
        const status = await checkIdentityStatus();
        if (!status.identity) { showScreen('verify'); startDLCamera(); }
        else { loadDashboard(); }
    } catch (e) {
        showError('login-error', e.message);
        showToast('error', 'Login failed', e.message);
    } finally {
        setButtonLoading('btn-login', false);
    }
}

async function checkIdentityStatus() {
    try {
        const res = await fetch(`${API_BASE}/api/identity/status`, { headers: { 'Authorization': `Bearer ${currentToken}` } });
        if (!res.ok) return { identity: false };
        return await res.json();
    } catch { return { identity: false }; }
}

function signOut() {
    currentToken = null;
    currentUser = null;
    localStorage.clear();
    showToast('info', 'Signed out', 'Come back soon!');
    showScreen('register');
}

function skipVerification() {
    stopCameras();
    loadDashboard();
}

// ============================================================================
// IDENTITY VERIFICATION (CAMERA)
// ============================================================================
async function startDLCamera() {
    try {
        dlStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        document.getElementById('dl-video').srcObject = dlStream;
    } catch (e) { showToast('error', 'Camera access denied', ''); }
}

function stopCameras() {
    dlStream?.getTracks().forEach(t => t.stop());
    selfieStream?.getTracks().forEach(t => t.stop());
}

function captureDL() {
    const video = document.getElementById('dl-video');
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    dlImageData = canvas.toDataURL('image/jpeg', 0.9);
    document.getElementById('dl-preview').src = dlImageData;
    document.getElementById('dl-preview').classList.remove('hidden');
    document.getElementById('dl-video').parentElement.classList.add('hidden');
    document.getElementById('btn-capture-dl').classList.add('hidden');
    document.getElementById('btn-retake-dl').classList.remove('hidden');
    document.getElementById('btn-confirm-dl').classList.remove('hidden');
    dlStream?.getTracks().forEach(t => t.stop());
}

async function retakeDL() {
    document.getElementById('dl-preview').classList.add('hidden');
    document.getElementById('dl-video').parentElement.classList.remove('hidden');
    document.getElementById('btn-capture-dl').classList.remove('hidden');
    document.getElementById('btn-retake-dl').classList.add('hidden');
    document.getElementById('btn-confirm-dl').classList.add('hidden');
    await startDLCamera();
}

async function confirmDL() {
    document.getElementById('verify-dl-section').classList.add('hidden');
    document.getElementById('verify-selfie-section').classList.remove('hidden');
    document.getElementById('verify-subtitle').textContent = 'Take a selfie';
    selfieStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
    document.getElementById('selfie-video').srcObject = selfieStream;
}

function captureSelfie() {
    const video = document.getElementById('selfie-video');
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    selfieImageData = canvas.toDataURL('image/jpeg', 0.9);
    document.getElementById('selfie-preview').src = selfieImageData;
    document.getElementById('selfie-preview').classList.remove('hidden');
    document.getElementById('selfie-video').parentElement.classList.add('hidden');
    document.getElementById('btn-capture-selfie').classList.add('hidden');
    document.getElementById('btn-retake-selfie').classList.remove('hidden');
    document.getElementById('btn-confirm-selfie').classList.remove('hidden');
    selfieStream?.getTracks().forEach(t => t.stop());
}

async function retakeSelfie() {
    document.getElementById('selfie-preview').classList.add('hidden');
    document.getElementById('selfie-video').parentElement.classList.remove('hidden');
    document.getElementById('btn-capture-selfie').classList.remove('hidden');
    document.getElementById('btn-retake-selfie').classList.add('hidden');
    document.getElementById('btn-confirm-selfie').classList.add('hidden');
    selfieStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
    document.getElementById('selfie-video').srcObject = selfieStream;
}

async function confirmSelfie() {
    document.getElementById('verify-selfie-section').classList.add('hidden');
    document.getElementById('verify-processing-section').classList.remove('hidden');
    document.getElementById('verify-subtitle').textContent = 'Verifying...';
    
    try {
        updateVerifyProgress(10, 'Loading face detection...');
        if (!faceApiLoaded) {
            const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model';
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
            ]);
            faceApiLoaded = true;
        }
        
        updateVerifyProgress(25, 'Reading driver\'s license...');
        const ocr = await Tesseract.recognize(dlImageData, 'eng');
        const dlInfo = parseDLText(ocr.data.text);
        
        updateVerifyProgress(50, 'Detecting faces...');
        const dlImg = await loadImage(dlImageData);
        const selfieImg = await loadImage(selfieImageData);
        const dlFace = await faceapi.detectSingleFace(dlImg, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
        if (!dlFace) throw new Error('No face found in DL');
        
        updateVerifyProgress(75, 'Comparing faces...');
        const selfieFace = await faceapi.detectSingleFace(selfieImg, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
        if (!selfieFace) throw new Error('No face found in selfie');
        
        const distance = faceapi.euclideanDistance(dlFace.descriptor, selfieFace.descriptor);
        const confidence = Math.round((1 - distance) * 100);
        if (distance > 0.6) throw new Error(`Face match failed (${confidence}%)`);
        
        updateVerifyProgress(90, 'Saving verification...');
        await fetch(`${API_BASE}/api/identity/save-verification`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentToken}` },
            body: JSON.stringify({ name: dlInfo.name, address: dlInfo.address, faceMatchConfidence: confidence })
        });
        
        verifiedDLInfo = dlInfo;
        localStorage.setItem('sunday_dl_info', JSON.stringify(dlInfo));
        if (dlInfo.name) {
            currentUser.name = dlInfo.name;
            localStorage.setItem('sunday_user', JSON.stringify(currentUser));
        }
        
        updateVerifyProgress(100, 'Complete!');
        showToast('success', 'Identity verified!', `${confidence}% face match`);
        setTimeout(() => loadDashboard(), 500);
    } catch (e) {
        showToast('error', 'Verification failed', e.message);
        loadDashboard();
    }
}

function updateVerifyProgress(pct, status) {
    document.getElementById('verify-progress').style.width = pct + '%';
    document.getElementById('verify-status').textContent = status;
}

function loadImage(src) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = src;
    });
}

function parseDLText(text) {
    const lines = text.split('\n').map(l => l.trim()).filter(Boolean);
    let name = '', address = '';
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].toUpperCase();
        if ((line.includes('LN ') || line.includes('LAST')) && lines[i + 1]) name = lines[i + 1];
        if ((line.includes('FN ') || line.includes('FIRST')) && lines[i + 1]) name = lines[i + 1] + ' ' + name;
        if (/^\d+\s+\w+/.test(lines[i]) && !lines[i].match(/^\d{2}[\/\-]/)) {
            address = lines[i];
            if (lines[i + 1] && /[A-Z]{2}\s+\d{5}/.test(lines[i + 1].toUpperCase())) address += ', ' + lines[i + 1];
        }
    }
    if (!name) { for (const l of lines) if (/^[A-Z][a-z]+\s+[A-Z][a-z]+/.test(l)) { name = l; break; } }
    return { name: name.trim(), address: address.trim() };
}

// ============================================================================
// DATA LOADING
// ============================================================================
async function loadInbox() {
    try {
        const res = await fetch(`${API_BASE}/api/messages/inbox`, { headers: { 'Authorization': `Bearer ${currentToken}` } });
        if (!res.ok) { showToast('warning', 'Session expired', 'Please sign in again'); return; }
        const data = await res.json();
        messages = data.messages || [];
        document.getElementById('stat-received').textContent = messages.length;
    } catch (e) { messages = []; showToast('error', 'Could not load inbox', ''); }
}

async function loadSentMessages() {
    try {
        const res = await fetch(`${API_BASE}/api/messages/sent`, { headers: { 'Authorization': `Bearer ${currentToken}` } });
        if (res.ok) { const data = await res.json(); sentMessages = data.messages || []; }
    } catch { sentMessages = []; }
}

async function loadClaims() {
    try {
        const res = await fetch(`${API_BASE}/api/claim/my-claims`, { headers: { 'Authorization': `Bearer ${currentToken}` } });
        if (res.ok) { const data = await res.json(); claims = data.claims || []; }
    } catch { claims = []; }
}

async function loadOwnedProperties() {
    try {
        const res = await fetch(`${API_BASE}/api/properties/owned`, { headers: { 'Authorization': `Bearer ${currentToken}` } });
        if (res.ok) { const data = await res.json(); ownedProperties = data.properties || []; }
    } catch { ownedProperties = []; }
    document.getElementById('stat-properties').textContent = ownedProperties.length;
}

async function loadPendingRequests() {
    try {
        const res = await fetch(`${API_BASE}/api/properties/pending-requests`, { headers: { 'Authorization': `Bearer ${currentToken}` } });
        if (res.ok) { const data = await res.json(); pendingRequests = data.requests || []; }
    } catch { pendingRequests = []; }
    document.getElementById('stat-pending').textContent = pendingRequests.length;
    updateNotificationBadges();
}

async function loadMyAccessRequests() {
    try {
        const res = await fetch(`${API_BASE}/api/properties/my-requests`, { headers: { 'Authorization': `Bearer ${currentToken}` } });
        if (res.ok) { const data = await res.json(); myAccessRequests = data.requests || []; }
    } catch { myAccessRequests = []; }
}

async function loadConnectedApps() {
    try {
        const res = await fetch(`${API_BASE}/api/oauth/apps`, { headers: { 'Authorization': `Bearer ${currentToken}` } });
        if (res.ok) { const data = await res.json(); connectedApps = data.apps || []; }
    } catch { connectedApps = []; }
}

async function checkAddressOwnership(addressId) {
    try {
        const res = await fetch(`${API_BASE}/api/properties/check-ownership/${addressId}`, { headers: { 'Authorization': `Bearer ${currentToken}` } });
        if (!res.ok) return { hasOwner: false };
        return await res.json();
    } catch { return { hasOwner: false }; }
}

function updateNotificationBadges() {
    const count = pendingRequests.length;
    ['owner-notification-badge', 'tab-owner-badge'].forEach(id => {
        const badge = document.getElementById(id);
        if (badge) {
            if (count > 0) { badge.textContent = count; badge.classList.remove('hidden'); }
            else { badge.classList.add('hidden'); }
        }
    });
}

function getUniqueAddresses() {
    const addressMap = new Map();
    const tierPriority = { OWNER: 4, PRIMARY: 3, SECONDARY: 2, DEPENDENT: 1, PENDING: 0 };
    
    ownedProperties.forEach(p => {
        const addr = p.address || p;
        const key = p.addressId || addr.id || addr.cryptoPropertyId;
        if (key) addressMap.set(key, { ...addr, addressId: key, tier: 'OWNER', isOwned: true });
    });
    
    claims.forEach(c => {
        const key = c.addressId || c.id || c.cryptoPropertyId;
        if (!key) return;
        const existing = addressMap.get(key);
        const claimTier = c.tier || 'PRIMARY';
        if (!existing || (tierPriority[claimTier] || 0) > (tierPriority[existing.tier] || 0)) {
            addressMap.set(key, { ...c, addressId: key, tier: claimTier, isOwned: false });
        }
    });
    
    return Array.from(addressMap.values());
}

function userHasClaimForAddress(addressId) {
    const ownedMatch = ownedProperties.find(p => (p.addressId || p.address?.id) === addressId);
    if (ownedMatch) return { hasClaim: true, tier: 'OWNER' };
    const claimMatch = claims.find(c => c.addressId === addressId);
    if (claimMatch) return { hasClaim: true, tier: claimMatch.tier || 'PRIMARY' };
    return { hasClaim: false };
}

// ============================================================================
// DASHBOARD
// ============================================================================
async function loadDashboard() {
    showScreen('dashboard');
    const storedDL = localStorage.getItem('sunday_dl_info');
    if (storedDL) verifiedDLInfo = JSON.parse(storedDL);
    document.getElementById('user-name').textContent = currentUser?.name || 'User';
    
    await Promise.all([
        loadInbox(),
        loadSentMessages(),
        loadClaims(),
        loadOwnedProperties(),
        loadPendingRequests(),
        loadMyAccessRequests(),
        loadConnectedApps()
    ]);
    
    updateWelcomeMessage();
    updateNotificationBadges();
    
    const pendingSend = localStorage.getItem('sunday_pending_send');
    if (pendingSend) {
        localStorage.removeItem('sunday_pending_send');
        setTab('compose');
        setTimeout(() => {
            const toField = document.getElementById('compose-to');
            if (toField) toField.value = pendingSend;
        }, 100);
    } else {
        setTab('inbox');
    }
}

function updateWelcomeMessage() {
    const msg = document.getElementById('welcome-message');
    const uniqueAddresses = getUniqueAddresses();
    if (messages.length > 0) {
        const unread = messages.filter(m => !m.isRead).length;
        msg.textContent = unread > 0 ? `You have ${unread} unread message${unread > 1 ? 's' : ''}!` : `You have ${messages.length} messages in your inbox.`;
    } else if (uniqueAddresses.length === 0) {
        msg.textContent = 'Your inbox is empty. Claim an address to start receiving messages!';
    } else {
        msg.textContent = `You have ${uniqueAddresses.length} claimed address${uniqueAddresses.length > 1 ? 'es' : ''}. Waiting for messages...`;
    }
}

// ============================================================================
// TAB MANAGEMENT
// ============================================================================
function setTab(tab) {
    currentTab = tab;
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`.tab-btn[data-tab="${tab}"]`)?.classList.add('active');
    document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
    document.getElementById(`tab-${tab}`)?.classList.remove('hidden');
    
    if (tab === 'inbox') renderInbox();
    else if (tab === 'sent') renderSent();
    else if (tab === 'addresses') renderAddresses();
    else if (tab === 'compose') renderCompose();
    else if (tab === 'claim') renderClaim();
    else if (tab === 'locker') renderLocker();
    else if (tab === 'settings') renderSettings();
    else if (tab === 'owner-dashboard') renderOwnerDashboard();
}

// ============================================================================
// INBOX
// ============================================================================
function renderInbox() {
    const container = document.getElementById('inbox-content');
    const uniqueAddresses = getUniqueAddresses();
    
    if (messages.length === 0) {
        if (uniqueAddresses.length === 0) {
            container.innerHTML = '<div class="address-empty"><div class="address-empty-icon">üì≠</div><div class="address-empty-title">Your inbox is empty</div><div class="address-empty-text">Claim an address to start receiving messages</div><span class="address-empty-link" onclick="setTab(\'claim\')">Claim your first address ‚Üí</span></div>';
        } else {
            container.innerHTML = '<div class="address-empty"><div class="address-empty-icon">üì¨</div><div class="address-empty-title">No messages yet</div><div class="address-empty-text">Share your CPiD to receive messages!</div><span class="address-empty-link" onclick="shareCPiD()">Share my CPiD ‚Üí</span></div>';
        }
        return;
    }
    
    container.innerHTML = messages.map(m => `
        <div class="message-item ${m.isRead ? '' : 'unread'}" onclick="viewMessage('${m.id}')">
            <div class="message-dot ${m.isRead ? 'read' : ''}"></div>
            <div class="message-content">
                <div class="message-from">From: ${escapeHtml(m.fromPhone || 'Unknown')}</div>
                <div class="message-subject">${escapeHtml(m.subject || 'No subject')}</div>
                <div class="message-preview">${escapeHtml(m.content || '')}</div>
            </div>
            <div class="message-meta">
                <div class="message-date">${formatDate(m.createdAt)}</div>
                ${m.toAddress ? `<div class="message-address-tag">${escapeHtml(m.toAddress.split(',')[0])}</div>` : ''}
            </div>
        </div>
    `).join('');
}

function viewMessage(id) {
    const msg = messages.find(m => m.id === id);
    if (!msg) return;
    
    fetch(`${API_BASE}/api/messages/${id}/read`, { method: 'PUT', headers: { 'Authorization': `Bearer ${currentToken}` } });
    msg.isRead = true;
    
    document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
    document.getElementById('tab-message-view').classList.remove('hidden');
    document.getElementById('message-view-content').innerHTML = `
        <button class="btn btn-ghost btn-sm" onclick="setTab('inbox')" style="margin:16px 24px;">‚Üê Back to Inbox</button>
        <div class="message-view">
            <div class="message-view-header">
                <div class="message-view-subject">${escapeHtml(msg.subject || 'No subject')}</div>
                <div class="message-view-meta">
                    <span><strong>From:</strong> ${escapeHtml(msg.fromPhone || 'Unknown')}</span>
                    <span><strong>To:</strong> ${escapeHtml(msg.toAddress || 'Your address')}</span>
                    <span><strong>Date:</strong> ${new Date(msg.createdAt).toLocaleString()}</span>
                </div>
            </div>
            <div class="message-view-body">${escapeHtml(msg.content || '')}</div>
        </div>
    `;
}

// ============================================================================
// SENT
// ============================================================================
function renderSent() {
    const container = document.getElementById('sent-content');
    
    if (sentMessages.length === 0) {
        container.innerHTML = '<div class="address-empty"><div class="address-empty-icon">üì§</div><div class="address-empty-title">No sent messages</div><div class="address-empty-text">Messages you send will appear here</div><span class="address-empty-link" onclick="setTab(\'compose\')">Send a message ‚Üí</span></div>';
        return;
    }
    
    container.innerHTML = sentMessages.map(m => `
        <div class="message-item" style="cursor:default;">
            <div class="message-dot read"></div>
            <div class="message-content">
                <div class="message-from">To: ${escapeHtml(m.toAddress || 'Unknown')}</div>
                <div class="message-subject">${escapeHtml(m.subject || 'No subject')}</div>
                <div class="message-preview">${escapeHtml(m.content || '')}</div>
            </div>
            <div class="message-meta">
                <div class="message-date">${formatDate(m.createdAt)}</div>
                ${m.isInEscrow ? '<div class="message-address-tag" style="background:#FEF3C7;color:#92400E;">In Escrow</div>' : ''}
            </div>
        </div>
    `).join('');
}

// ============================================================================
// ADDRESSES
// ============================================================================
function renderAddresses() {
    const container = document.getElementById('addresses-content');
    container.innerHTML = '<div class="address-header"><h2 class="address-title">My Addresses</h2><button class="btn btn-primary btn-sm" onclick="setTab(\'claim\')">+ Claim New</button></div>';
    
    const uniqueAddresses = getUniqueAddresses();
    
    if (uniqueAddresses.length === 0) {
        container.innerHTML += '<div class="address-empty"><div class="address-empty-icon">üè†</div><div class="address-empty-title">No addresses claimed</div><span class="address-empty-link" onclick="setTab(\'claim\')">Claim your first address ‚Üí</span></div>';
        return;
    }
    
    uniqueAddresses.forEach(addr => {
        const tier = addr.tier || 'CLAIMED';
        container.innerHTML += `
            <div class="address-card">
                <div class="address-card-header">
                    <span class="address-card-icon">üè†</span>
                    ${getTierBadge(tier)}
                </div>
                <div class="address-card-street">${escapeHtml(addr.street || '')}</div>
                <div class="address-card-city">${escapeHtml(addr.city || '')}, ${escapeHtml(addr.state || '')} ${escapeHtml(addr.postalCode || '')}</div>
                <div class="address-card-cpid">
                    <span>${addr.cryptoPropertyId || 'Generating...'}</span>
                    <button class="copy-btn" onclick="copyToClipboard('${addr.cryptoPropertyId}', this)">üìã</button>
                </div>
            </div>
        `;
    });
    
    const pendingMyReqs = myAccessRequests.filter(r => r.status === 'PENDING');
    if (pendingMyReqs.length > 0) {
        container.innerHTML += '<h3 style="margin:24px 0 12px;font-size:16px;color:var(--text-secondary);">Pending Access Requests</h3>';
        pendingMyReqs.forEach(r => {
            container.innerHTML += `
                <div class="address-card" style="border-left:4px solid var(--accent-amber);">
                    <div class="address-card-header">
                        <span class="address-card-icon">‚è≥</span>
                        ${getTierBadge('PENDING')}
                    </div>
                    <div class="address-card-street">${escapeHtml(r.property?.address?.street || 'Address')}</div>
                    <div style="font-size:13px;color:var(--text-muted);margin-top:8px;">Waiting for owner approval...</div>
                </div>
            `;
        });
    }
}

// ============================================================================
// COMPOSE
// ============================================================================
function renderCompose() {
    const container = document.getElementById('compose-content');
    container.innerHTML = `
        <div class="compose-form">
            <div class="input-group">
                <label class="input-label">To (Address or CPiD)</label>
                <input type="text" class="input-field" id="compose-to" placeholder="123 Main St, City, State 12345 or CPID-XXXX">
            </div>
            <div class="input-group">
                <label class="input-label">Subject</label>
                <input type="text" class="input-field" id="compose-subject" placeholder="Message subject">
            </div>
            <div class="input-group">
                <label class="input-label">Message</label>
                <textarea id="compose-content-field" placeholder="Write your message..."></textarea>
            </div>
            <button class="btn btn-primary" id="btn-send-message" onclick="sendMessage()">üì§ Send Message</button>
            <div id="compose-error" class="error-box hidden"></div>
            <div id="compose-success" class="success-box hidden"></div>
        </div>
    `;
    
    // Init Google Places on compose field
    setTimeout(() => { initAddressAutocomplete('compose-to', null); }, 100);
}

async function sendMessage() {
    const to = document.getElementById('compose-to').value.trim();
    const subject = document.getElementById('compose-subject').value.trim();
    const content = document.getElementById('compose-content-field').value.trim();
    
    if (!to || !subject || !content) { showError('compose-error', 'All fields are required'); return; }
    hideError('compose-error');
    document.getElementById('compose-success').classList.add('hidden');
    setButtonLoading('btn-send-message', true);
    
    try {
        const res = await fetch(`${API_BASE}/api/messages/send`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentToken}` },
            body: JSON.stringify({ toAddress: to, subject, content, fromPhone: currentUser?.phone || 'Unknown' })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || 'Failed to send');
        
        const successEl = document.getElementById('compose-success');
        successEl.innerHTML = `<strong>‚úì Message sent!</strong> ${data.isInEscrow ? '<br><span style="font-size:12px;">Message held in escrow until address is claimed.</span>' : ''}`;
        successEl.classList.remove('hidden');
        
        document.getElementById('compose-to').value = '';
        document.getElementById('compose-subject').value = '';
        document.getElementById('compose-content-field').value = '';
        
        document.getElementById('stat-sent').textContent = parseInt(document.getElementById('stat-sent').textContent) + 1;
        showToast('success', 'Message sent!', data.isInEscrow ? 'Held in escrow' : 'Delivered successfully');
    } catch (e) {
        showError('compose-error', e.message);
        showToast('error', 'Send failed', e.message);
    } finally {
        setButtonLoading('btn-send-message', false);
    }
}

// ============================================================================
// CLAIM ADDRESS
// ============================================================================
function renderClaim() {
    const dlAddr = verifiedDLInfo?.address;
    const container = document.getElementById('claim-content');
    
    container.innerHTML = `
        <div id="claim-step-1">
            ${dlAddr ? `
                <div class="claim-preview">
                    <div class="claim-preview-label">üìã Address from your DL</div>
                    <div class="claim-preview-text">${escapeHtml(dlAddr)}</div>
                    <button class="btn btn-outline btn-sm" style="margin-top:12px;" onclick="useDLAddress()">Use This Address</button>
                </div>
            ` : ''}
            <div class="input-group">
                <label class="input-label">Street Address</label>
                <input type="text" class="input-field" id="claim-street" placeholder="Start typing address...">
            </div>
            <div class="input-row">
                <div class="input-group">
                    <label class="input-label">City</label>
                    <input type="text" class="input-field" id="claim-city" placeholder="Tampa">
                </div>
                <div class="input-group" style="max-width:80px;">
                    <label class="input-label">State</label>
                    <input type="text" class="input-field" id="claim-state" placeholder="FL" maxlength="2">
                </div>
                <div class="input-group" style="max-width:110px;">
                    <label class="input-label">ZIP</label>
                    <input type="text" class="input-field" id="claim-zip" placeholder="33602">
                </div>
            </div>
            <button class="btn btn-primary" id="btn-check-address" onclick="checkAddressAndProceed()">Continue ‚Üí</button>
            <div id="claim-error" class="error-box hidden"></div>
        </div>
        
        <div id="claim-step-tier" class="hidden">
            <div class="claim-preview" style="margin-bottom:24px;">
                <div class="claim-preview-label">üìç Address</div>
                <div class="claim-preview-text" id="claim-address-preview">‚Äî</div>
            </div>
            <div id="already-claimed-warning" class="warning-box hidden" style="margin-bottom:20px;"></div>
            <div id="owner-exists-warning" class="owner-info-box hidden">
                <h4>üëë This property has an owner</h4>
                <p>Someone has claimed ownership. You can request access as a resident.</p>
            </div>
            <h3 style="margin-bottom:16px;font-size:16px;">How would you like to claim this address?</h3>
            <div class="tier-select">
                <label class="tier-option" id="tier-option-owner" onclick="selectClaimTier('OWNER')">
                    <input type="radio" name="claim-tier" value="OWNER">
                    <span class="tier-icon">üëë</span>
                    <div class="tier-details"><h4>Property Owner</h4><p>I own this property (deed holder)</p></div>
                </label>
                <label class="tier-option" onclick="selectClaimTier('PRIMARY')">
                    <input type="radio" name="claim-tier" value="PRIMARY">
                    <span class="tier-icon">üè†</span>
                    <div class="tier-details"><h4>Primary Resident</h4><p>I rent/lease this property</p></div>
                </label>
                <label class="tier-option" onclick="selectClaimTier('SECONDARY')">
                    <input type="radio" name="claim-tier" value="SECONDARY">
                    <span class="tier-icon">üîë</span>
                    <div class="tier-details"><h4>Secondary Resident</h4><p>I live here (roommate, etc.)</p></div>
                </label>
                <label class="tier-option" onclick="selectClaimTier('DEPENDENT')">
                    <input type="radio" name="claim-tier" value="DEPENDENT">
                    <span class="tier-icon">üë§</span>
                    <div class="tier-details"><h4>Dependent</h4><p>Minor or dependent at this address</p></div>
                </label>
            </div>
            <button class="btn btn-primary" id="btn-proceed-tier" onclick="proceedWithTier()" disabled>Continue ‚Üí</button>
            <button class="btn btn-ghost" onclick="backToStep1()" style="margin-top:8px;">‚Üê Back</button>
            <div id="claim-error-tier" class="error-box hidden"></div>
        </div>
        
        <div id="claim-step-request" class="hidden">
            <div class="claim-preview" style="margin-bottom:24px;">
                <div class="claim-preview-label">üìç Requesting Access</div>
                <div class="claim-preview-text" id="claim-address-preview-request">‚Äî</div>
            </div>
            <div class="owner-info-box" style="margin-bottom:20px;">
                <h4>üëë Owner Approval Required</h4>
                <p>The property owner will be notified of your request.</p>
            </div>
            <div class="input-group">
                <label class="input-label">Your relationship to this address</label>
                <textarea class="input-field" id="request-relationship" placeholder="e.g., I'm renting the upstairs apartment..." style="min-height:100px;"></textarea>
            </div>
            <button class="btn btn-primary" id="btn-submit-request" onclick="submitAccessRequest()">üì§ Submit Request</button>
            <button class="btn btn-ghost" onclick="backToTierSelection()" style="margin-top:8px;">‚Üê Back</button>
            <div id="claim-error-request" class="error-box hidden"></div>
        </div>
        
        <div id="claim-success" class="success-box hidden"></div>
    `;
    
    // Init Google Places autocomplete
    setTimeout(() => {
        initAddressAutocomplete('claim-street', (parsed) => {
            document.getElementById('claim-street').value = parsed.street;
            document.getElementById('claim-city').value = parsed.city;
            document.getElementById('claim-state').value = parsed.state;
            document.getElementById('claim-zip').value = parsed.postalCode;
        });
    }, 100);
}

async function checkAddressAndProceed() {
    const street = document.getElementById('claim-street').value.trim();
    const city = document.getElementById('claim-city').value.trim();
    const state = document.getElementById('claim-state').value.trim().toUpperCase();
    const postalCode = document.getElementById('claim-zip').value.trim();
    
    if (!street || !city || !state || !postalCode) { showError('claim-error', 'All fields are required'); return; }
    hideError('claim-error');
    setButtonLoading('btn-check-address', true);
    pendingClaimAddress = { street, city, state, postalCode };
    
    try {
        const lookupRes = await fetch(`${API_BASE}/api/addresses/lookup`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentToken}` },
            body: JSON.stringify({ street, city, state, postalCode })
        });
        const lookupData = await lookupRes.json();
        if (!lookupRes.ok) throw new Error(lookupData.message || 'Failed to lookup');
        
        pendingClaimAddressId = lookupData.address.id;
        addressOwnershipInfo = await checkAddressOwnership(pendingClaimAddressId);
        
        const existingClaim = userHasClaimForAddress(pendingClaimAddressId);
        const alreadyClaimedWarning = document.getElementById('already-claimed-warning');
        if (existingClaim.hasClaim) {
            alreadyClaimedWarning.innerHTML = `<strong>‚úì You already have access to this address</strong><br><span style="font-size:13px;">Current tier: ${getTierBadge(existingClaim.tier)}</span>`;
            alreadyClaimedWarning.classList.remove('hidden');
        } else {
            alreadyClaimedWarning.classList.add('hidden');
        }
        
        const addrText = `${street}, ${city}, ${state} ${postalCode}`;
        document.getElementById('claim-address-preview').textContent = addrText;
        document.getElementById('claim-address-preview-request').textContent = addrText;
        
        const ownerWarning = document.getElementById('owner-exists-warning');
        const ownerOption = document.getElementById('tier-option-owner');
        if (addressOwnershipInfo.hasOwner) {
            ownerWarning.classList.remove('hidden');
            ownerOption.classList.add('disabled');
            ownerOption.querySelector('.tier-details p').textContent = '‚úó Already has a registered owner';
        } else {
            ownerWarning.classList.add('hidden');
            ownerOption.classList.remove('disabled');
            ownerOption.querySelector('.tier-details p').textContent = 'I own this property (deed holder)';
        }
        
        document.getElementById('claim-step-1').classList.add('hidden');
        document.getElementById('claim-step-tier').classList.remove('hidden');
        selectedClaimTier = null;
        document.getElementById('btn-proceed-tier').disabled = true;
        document.querySelectorAll('.tier-option').forEach(el => el.classList.remove('selected'));
    } catch (e) {
        showError('claim-error', e.message);
    } finally {
        setButtonLoading('btn-check-address', false);
    }
}

function selectClaimTier(tier) {
    if (tier === 'OWNER' && addressOwnershipInfo?.hasOwner) return;
    selectedClaimTier = tier;
    document.querySelectorAll('.tier-option').forEach(el => el.classList.remove('selected'));
    document.querySelector(`.tier-option input[value="${tier}"]`)?.parentElement.classList.add('selected');
    document.getElementById('btn-proceed-tier').disabled = false;
}

function proceedWithTier() {
    if (!selectedClaimTier) return;
    hideError('claim-error-tier');
    
    const existingClaim = userHasClaimForAddress(pendingClaimAddressId);
    if (existingClaim.hasClaim) {
        showError('claim-error-tier', `You already have access as ${existingClaim.tier}.`);
        return;
    }
    
    if (selectedClaimTier === 'OWNER') {
        // For now, claim directly as owner (in production, would verify deed)
        claimAddressDirectly();
    } else if (addressOwnershipInfo.hasOwner) {
        // Need owner approval
        document.getElementById('claim-step-tier').classList.add('hidden');
        document.getElementById('claim-step-request').classList.remove('hidden');
    } else {
        // No owner, claim directly
        claimAddressDirectly();
    }
}

function backToStep1() {
    document.getElementById('claim-step-tier').classList.add('hidden');
    document.getElementById('claim-step-1').classList.remove('hidden');
}

function backToTierSelection() {
    document.getElementById('claim-step-request').classList.add('hidden');
    document.getElementById('claim-step-tier').classList.remove('hidden');
}

async function claimAddressDirectly() {
    try {
        const { street, city, state, postalCode } = pendingClaimAddress;
        const claimRes = await fetch(`${API_BASE}/api/claim`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentToken}` },
            body: JSON.stringify({ addressId: pendingClaimAddressId, tier: selectedClaimTier, verificationMethod: 'SELF_DECLARED' })
        });
        const claimData = await claimRes.json();
        if (!claimRes.ok) throw new Error(claimData.message || 'Failed to claim');
        
        document.querySelectorAll('[id^="claim-step-"]').forEach(el => el.classList.add('hidden'));
        const successEl = document.getElementById('claim-success');
        successEl.innerHTML = `
            <div style="font-weight:700;margin-bottom:8px;font-size:18px;">üéâ Address Claimed!</div>
            <div style="font-family:monospace;color:var(--primary);font-size:14px;">${claimData.claim?.cryptoPropertyId || claimData.cryptoPropertyId || 'CPiD Generated'}</div>
            <div style="margin-top:8px;">${escapeHtml(street)}, ${escapeHtml(city)}, ${escapeHtml(state)}</div>
            <div style="margin-top:12px;">${getTierBadge(selectedClaimTier)}</div>
        `;
        successEl.classList.remove('hidden');
        showToast('success', 'Address claimed!', 'You can now receive messages here');
        
        await Promise.all([loadClaims(), loadOwnedProperties()]);
        updateWelcomeMessage();
    } catch (e) {
        showError('claim-error-tier', e.message);
        showToast('error', 'Claim failed', e.message);
    }
}

async function submitAccessRequest() {
    const relationship = document.getElementById('request-relationship').value.trim();
    if (!relationship) { showError('claim-error-request', 'Please describe your relationship'); return; }
    hideError('claim-error-request');
    setButtonLoading('btn-submit-request', true);
    
    try {
        const res = await fetch(`${API_BASE}/api/properties/request-access`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentToken}` },
            body: JSON.stringify({ propertyId: addressOwnershipInfo.propertyId, requestedTier: selectedClaimTier, relationshipDescription: relationship })
        });
        if (!res.ok) { const data = await res.json(); throw new Error(data.message || 'Failed to request'); }
        
        document.querySelectorAll('[id^="claim-step-"]').forEach(el => el.classList.add('hidden'));
        const successEl = document.getElementById('claim-success');
        successEl.innerHTML = `
            <div style="font-weight:700;margin-bottom:8px;font-size:18px;">üì§ Access Request Submitted!</div>
            <div style="margin-top:8px;">${escapeHtml(pendingClaimAddress.street)}, ${escapeHtml(pendingClaimAddress.city)}, ${escapeHtml(pendingClaimAddress.state)}</div>
            <div style="margin-top:8px;font-size:13px;color:var(--text-secondary);">The owner has been notified. You'll receive messages once approved.</div>
            <div style="margin-top:12px;">${getTierBadge('PENDING')}</div>
        `;
        successEl.classList.remove('hidden');
        showToast('success', 'Request submitted!', 'Waiting for owner approval');
        await loadMyAccessRequests();
    } catch (e) {
        showError('claim-error-request', e.message);
        showToast('error', 'Request failed', e.message);
    } finally {
        setButtonLoading('btn-submit-request', false);
    }
}

function useDLAddress() {
    if (!verifiedDLInfo?.address) return;
    const parts = verifiedDLInfo.address.split(',').map(p => p.trim());
    if (parts[0]) document.getElementById('claim-street').value = parts[0];
    if (parts[1]) {
        const match = parts[1].match(/(.+?)\s+([A-Z]{2})\s*(\d{5})?/i);
        if (match) {
            document.getElementById('claim-city').value = match[1].trim();
            document.getElementById('claim-state').value = match[2].toUpperCase();
            if (match[3]) document.getElementById('claim-zip').value = match[3];
        }
    }
}

// ============================================================================
// OWNER DASHBOARD
// ============================================================================
async function renderOwnerDashboard() {
    const container = document.getElementById('owner-dashboard-content');
    container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">Loading...</div>';
    
    await Promise.all([loadOwnedProperties(), loadPendingRequests()]);
    updateNotificationBadges();
    
    if (ownedProperties.length === 0 && pendingRequests.length === 0) {
        container.innerHTML = `
            <div class="address-empty">
                <div class="address-empty-icon">üëë</div>
                <div class="address-empty-title">No properties owned</div>
                <div class="address-empty-text">Claim a property as owner to manage resident access</div>
                <span class="address-empty-link" onclick="setTab('claim')">Claim a property ‚Üí</span>
            </div>
        `;
        return;
    }
    
    let html = '';
    
    // Pending Requests Section
    if (pendingRequests.length > 0) {
        html += `
            <div style="margin-bottom:32px;">
                <h3 style="font-size:16px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px;">
                    <span style="background:var(--accent-amber);color:white;padding:4px 10px;border-radius:100px;font-size:12px;">${pendingRequests.length}</span>
                    Pending Access Requests
                </h3>
        `;
        
        pendingRequests.forEach(req => {
            const initials = (req.requester?.displayName || 'U').substring(0, 2).toUpperCase();
            html += `
                <div class="request-card">
                    <div class="request-header">
                        <div class="request-user">
                            <div class="request-avatar">${initials}</div>
                            <div class="request-info">
                                <h4>${escapeHtml(req.requester?.displayName || 'Unknown User')}</h4>
                                <p>${escapeHtml(req.requester?.phone || '')}</p>
                            </div>
                        </div>
                        ${getTierBadge(req.requestedTier)}
                    </div>
                    <div class="request-address">üìç ${escapeHtml(req.property?.address?.street || 'Address')}, ${escapeHtml(req.property?.address?.city || '')}</div>
                    ${req.relationshipDescription ? `<div style="font-size:13px;color:var(--text-secondary);margin-bottom:12px;padding:10px;background:var(--bg-white);border-radius:8px;"><strong>Reason:</strong> ${escapeHtml(req.relationshipDescription)}</div>` : ''}
                    <div class="request-actions">
                        <button class="btn btn-success btn-sm" onclick="handleApproveRequest('${req.id}', '${req.requestedTier}')">‚úì Approve</button>
                        <button class="btn btn-danger btn-sm" onclick="handleDenyRequest('${req.id}')">‚úó Deny</button>
                    </div>
                </div>
            `;
        });
        html += '</div>';
    }
    
    // Owned Properties Section
    if (ownedProperties.length > 0) {
        html += '<h3 style="font-size:16px;font-weight:700;margin-bottom:16px;">My Properties</h3>';
        
        for (const prop of ownedProperties) {
            const addr = prop.address || prop;
            const residents = prop.residents || [];
            
            html += `
                <div class="address-card" style="background:linear-gradient(135deg,rgba(212,175,55,0.1),rgba(184,134,11,0.05));">
                    <div class="address-card-header">
                        <span class="address-card-icon">üè†</span>
                        ${getTierBadge('OWNER')}
                    </div>
                    <div class="address-card-street">${escapeHtml(addr.street || '')}</div>
                    <div class="address-card-city">${escapeHtml(addr.city || '')}, ${escapeHtml(addr.state || '')} ${escapeHtml(addr.postalCode || '')}</div>
                    <div class="address-card-cpid">
                        <span>${addr.cryptoPropertyId || 'Generating...'}</span>
                        <button class="copy-btn" onclick="copyToClipboard('${addr.cryptoPropertyId}', this)">üìã</button>
                    </div>
                    
                    <div style="margin-top:20px;">
                        <h4 style="font-size:13px;font-weight:600;color:var(--text-secondary);margin-bottom:12px;">
                            Authorized Residents (${residents.length})
                        </h4>
            `;
            
            if (residents.length > 0) {
                residents.forEach(r => {
                    const rInitials = (r.user?.displayName || 'U').substring(0, 2).toUpperCase();
                    html += `
                        <div class="resident-item">
                            <div class="resident-info">
                                <div class="resident-avatar">${rInitials}</div>
                                <div>
                                    <div class="resident-name">${escapeHtml(r.user?.displayName || 'Unknown')}</div>
                                    <div class="resident-phone">${escapeHtml(r.user?.phone || '')}</div>
                                </div>
                            </div>
                            <div style="display:flex;align-items:center;gap:8px;">
                                ${getTierBadge(r.tier)}
                                <button class="btn btn-ghost btn-sm" onclick="handleRevokeAccess('${r.id}', '${escapeHtml(r.user?.displayName || 'this resident')}')" style="color:var(--accent-rose);padding:6px 10px;">‚úó</button>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += '<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:13px;">No authorized residents yet</div>';
            }
            
            html += '</div></div>';
        }
    }
    
    container.innerHTML = html;
}

async function handleApproveRequest(requestId, tier) {
    try {
        const res = await fetch(`${API_BASE}/api/properties/approve-request/${requestId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentToken}` },
            body: JSON.stringify({ approvedTier: tier })
        });
        if (!res.ok) { const data = await res.json(); throw new Error(data.message || 'Failed to approve'); }
        
        showToast('success', 'Access approved!', 'The resident can now receive messages');
        renderOwnerDashboard();
    } catch (e) {
        showToast('error', 'Approval failed', e.message);
    }
}

async function handleDenyRequest(requestId) {
    const reason = prompt('Reason for denial (optional):');
    try {
        const res = await fetch(`${API_BASE}/api/properties/deny-request/${requestId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentToken}` },
            body: JSON.stringify({ reason: reason || '' })
        });
        if (!res.ok) { const data = await res.json(); throw new Error(data.message || 'Failed to deny'); }
        
        showToast('info', 'Access denied', 'The request has been rejected');
        renderOwnerDashboard();
    } catch (e) {
        showToast('error', 'Denial failed', e.message);
    }
}

async function handleRevokeAccess(authorizationId, name) {
    if (!confirm(`Revoke access for ${name}?\n\nThey will no longer be able to receive messages at this address.`)) return;
    
    try {
        const res = await fetch(`${API_BASE}/api/properties/revoke-access/${authorizationId}`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${currentToken}` }
        });
        if (!res.ok) { const data = await res.json(); throw new Error(data.message || 'Failed to revoke'); }
        
        showToast('success', 'Access revoked', `${name} has been removed`);
        renderOwnerDashboard();
    } catch (e) {
        showToast('error', 'Revocation failed', e.message);
    }
}

// ============================================================================
// THE LOCKER (Connected Apps)
// ============================================================================
async function renderLocker() {
    const container = document.getElementById('locker-content');
    container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">Loading connected apps...</div>';
    
    await loadConnectedApps();
    
    if (connectedApps.length === 0) {
        container.innerHTML = `
            <div class="address-empty">
                <div class="address-empty-icon">üîí</div>
                <div class="address-empty-title">No connected apps</div>
                <div class="address-empty-text">Apps you sign into with Sunday will appear here.<br>You can manage access and revoke permissions at any time.</div>
            </div>
        `;
        return;
    }
    
    const activeApps = connectedApps.filter(a => a.isActive);
    const revokedApps = connectedApps.filter(a => !a.isActive);
    
    let html = '<p style="color:var(--text-muted);margin-bottom:20px;font-size:14px;">These apps have access to your Sunday identity. You can revoke access at any time.</p>';
    
    if (activeApps.length > 0) {
        html += '<h4 style="font-size:14px;color:var(--text-secondary);margin-bottom:12px;">Active Connections</h4>';
        activeApps.forEach(app => {
            html += `
                <div class="address-card" style="display:flex;align-items:center;justify-content:space-between;">
                    <div style="display:flex;align-items:center;gap:16px;">
                        <div style="font-size:32px;">${app.appIcon || 'üîó'}</div>
                        <div>
                            <div style="font-weight:600;font-size:16px;">${escapeHtml(app.appName)}</div>
                            <div style="font-size:12px;color:var(--text-muted);">Connected ${formatDate(app.connectedAt)} ‚Ä¢ Last used ${formatDate(app.lastUsedAt)}</div>
                        </div>
                    </div>
                    <button class="btn btn-ghost btn-sm" onclick="revokeApp('${app.appId}', '${escapeHtml(app.appName)}')" style="color:var(--accent-rose);">Disconnect</button>
                </div>
            `;
        });
    }
    
    if (revokedApps.length > 0) {
        html += '<h4 style="font-size:14px;color:var(--text-muted);margin:24px 0 12px;">Previously Connected</h4>';
        revokedApps.forEach(app => {
            html += `
                <div class="address-card" style="opacity:0.6;display:flex;align-items:center;justify-content:space-between;">
                    <div style="display:flex;align-items:center;gap:16px;">
                        <div style="font-size:32px;">${app.appIcon || 'üîó'}</div>
                        <div>
                            <div style="font-weight:600;font-size:16px;">${escapeHtml(app.appName)}</div>
                            <div style="font-size:12px;color:var(--text-muted);">Access revoked</div>
                        </div>
                    </div>
                    <span style="font-size:12px;color:var(--text-muted);">Disconnected</span>
                </div>
            `;
        });
    }
    
    container.innerHTML = html;
}

async function revokeApp(appId, appName) {
    if (!confirm(`Disconnect ${appName}?\n\nThis will revoke the app's access to your Sunday identity.`)) return;
    
    try {
        const res = await fetch(`${API_BASE}/api/oauth/revoke`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentToken}` },
            body: JSON.stringify({ app_id: appId })
        });
        if (res.ok) {
            showToast('success', 'Disconnected', `${appName} has been removed`);
            renderLocker();
        } else {
            const data = await res.json();
            showToast('error', 'Failed to disconnect', data.error_description || 'Unknown error');
        }
    } catch (e) {
        showToast('error', 'Failed to disconnect', e.message);
    }
}

// ============================================================================
// SETTINGS
// ============================================================================
function renderSettings() {
    const container = document.getElementById('settings-content');
    container.innerHTML = `
        <h3 style="margin-bottom:20px;">Account Settings</h3>
        <div class="input-group">
            <label class="input-label">Name</label>
            <input type="text" class="input-field" value="${escapeHtml(currentUser?.name || '')}" disabled>
        </div>
        <div class="input-group">
            <label class="input-label">Phone</label>
            <input type="text" class="input-field" value="${escapeHtml(currentUser?.phone || '')}" disabled>
        </div>
        <div class="input-group">
            <label class="input-label">Identity Status</label>
            <input type="text" class="input-field" value="${verifiedDLInfo ? '‚úì Verified' : 'Not Verified'}" disabled style="${verifiedDLInfo ? 'color:var(--accent-emerald);' : ''}">
        </div>
        <div style="padding:16px;background:var(--bg-gray);border-radius:12px;margin-top:20px;">
            <div style="font-size:13px;color:var(--text-muted);">App Version</div>
            <div style="font-size:16px;font-weight:600;">SUNDAY v${APP_VERSION}</div>
        </div>
        <button class="btn btn-ghost" onclick="signOut()" style="margin-top:20px;">üö™ Sign Out</button>
    `;
}

// ============================================================================
// SHARE CPID
// ============================================================================
function shareCPiD() {
    const uniqueAddresses = getUniqueAddresses();
    if (uniqueAddresses.length === 0) {
        showToast('info', 'No addresses', 'Claim an address first to share your CPiD');
        setTab('claim');
        return;
    }
    
    const cpid = uniqueAddresses[0]?.cryptoPropertyId;
    const shareUrl = `https://msg-headquarters.github.io/sunday-mail/?send=${cpid}`;
    
    if (navigator.share) {
        navigator.share({ title: 'My Sunday CPiD', text: `Send me secure mail at: ${cpid}`, url: shareUrl }).catch(() => copyToClipboard(shareUrl));
    } else {
        copyToClipboard(shareUrl);
        showToast('success', 'Link copied!', 'Share this link to receive messages');
    }
}

// ============================================================================
// INITIALIZATION
// ============================================================================
document.addEventListener('DOMContentLoaded', () => {
    console.log(`SUNDAY Platform v${APP_VERSION} initialized`);
    
    const urlParams = new URLSearchParams(window.location.search);
    const sendToCPiD = urlParams.get('send');
    
    const token = localStorage.getItem('sunday_token');
    const user = localStorage.getItem('sunday_user');
    
    if (token && user) {
        currentToken = token;
        currentUser = JSON.parse(user);
        loadDashboard().then(() => {
            if (sendToCPiD) {
                setTab('compose');
                setTimeout(() => {
                    const toField = document.getElementById('compose-to');
                    if (toField) toField.value = sendToCPiD;
                }, 100);
            }
        });
    } else if (sendToCPiD) {
        localStorage.setItem('sunday_pending_send', sendToCPiD);
        showScreen('register');
    } else {
        showScreen('register');
    }
});
    </script>
</body>
</html>